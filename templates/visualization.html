<!DOCTYPE html>
<html>
<!-- ... previous head and style sections ... -->
<body>
    <div class="filter-section">
        <!-- Node Types -->
        <div class="filter-group">
            <div class="filter-label">node types</div>
            <div class="button-container">
                <button class="filter-button" onclick="toggleFilter(this, 'nerve', 'nodeTypes')">nerve</button>
                <button class="filter-button" onclick="toggleFilter(this, 'bone', 'nodeTypes')">bone</button>
                <button class="filter-button" onclick="toggleFilter(this, 'neuro', 'nodeTypes')">neuro</button>
                <button class="filter-button" onclick="toggleFilter(this, 'region', 'nodeTypes')">region</button>
                <button class="filter-button" onclick="toggleFilter(this, 'viscera', 'nodeTypes')">viscera</button>
                <button class="filter-button" onclick="toggleFilter(this, 'muscle', 'nodeTypes')">muscle</button>
                <button class="filter-button" onclick="toggleFilter(this, 'sense', 'nodeTypes')">sense</button>
                <button class="filter-button" onclick="toggleFilter(this, 'vein', 'nodeTypes')">vein</button>
                <button class="filter-button" onclick="toggleFilter(this, 'artery', 'nodeTypes')">artery</button>
                <button class="filter-button" onclick="toggleFilter(this, 'cv', 'nodeTypes')">cv</button>
                <button class="filter-button" onclick="toggleFilter(this, 'function', 'nodeTypes')">function</button>
                <button class="filter-button" onclick="toggleFilter(this, 'sensory', 'nodeTypes')">sensory</button>
                <button class="filter-button" onclick="toggleFilter(this, 'gland', 'nodeTypes')">gland</button>
                <button class="filter-button" onclick="toggleFilter(this, 'lymph', 'nodeTypes')">lymph</button>
                <button class="filter-button" onclick="toggleFilter(this, 'head', 'nodeTypes')">head</button>
                <button class="filter-button" onclick="toggleFilter(this, 'organ', 'nodeTypes')">organ</button>
                <button class="filter-button" onclick="toggleFilter(this, 'sensation', 'nodeTypes')">sensation</button>
                <button class="filter-button" onclick="toggleFilter(this, 'skin', 'nodeTypes')">skin</button>
            </div>
        </div>
        <!-- ... other filter groups ... -->
    </div>

    <div id="graph"></div>

    <script>
        // Initialize filter sets
        const activeFilters = {
            nodeTypes: new Set(),
            locations: new Set(),
            sublocations: new Set()
        };

        function toggleFilter(button, value, filterType) {
            button.classList.toggle('active');
            
            if (button.classList.contains('active')) {
                activeFilters[filterType].add(value.toLowerCase());
            } else {
                activeFilters[filterType].delete(value.toLowerCase());
            }
            
            updateNodeVisibility();
        }

        function updateNodeVisibility() {
            const nodes = d3.selectAll('.node');
            const links = d3.selectAll('.link');

            nodes.each(function(d) {
                // Get the node's labels (type)
                const nodeTypes = Array.isArray(d.labels) ? d.labels.map(l => l.toLowerCase()) : [];
                const nodeLocation = (d.properties?.location || '').toLowerCase();
                const nodeSublocation = (d.properties?.sublocation || '').toLowerCase();

                // Check if node matches any active filters
                const matchesType = activeFilters.nodeTypes.size === 0 || 
                                  nodeTypes.some(type => activeFilters.nodeTypes.has(type));
                const matchesLocation = activeFilters.locations.size === 0 || 
                                      activeFilters.locations.has(nodeLocation);
                const matchesSublocation = activeFilters.sublocations.size === 0 || 
                                         activeFilters.sublocations.has(nodeSublocation);

                // Node is visible if it matches at least one active filter category
                const isVisible = matchesType && 
                                (activeFilters.locations.size === 0 || matchesLocation) && 
                                (activeFilters.sublocations.size === 0 || matchesSublocation);

                d3.select(this)
                    .style('opacity', isVisible ? 1 : 0.1)
                    .style('pointer-events', isVisible ? 'all' : 'none');
            });

            // Update link visibility
            links.each(function(d) {
                const sourceVisible = d3.select(`.node[data-id="${d.source.id}"]`).style('opacity') === '1';
                const targetVisible = d3.select(`.node[data-id="${d.target.id}"]`).style('opacity') === '1';
                
                d3.select(this)
                    .style('opacity', (sourceVisible && targetVisible) ? 0.6 : 0.1)
                    .style('pointer-events', (sourceVisible && targetVisible) ? 'all' : 'none');
            });
        }

        // Debug function to help see what's happening
        function logNodeData() {
            const nodes = d3.selectAll('.node');
            console.log('Active Filters:', activeFilters);
            nodes.each(function(d) {
                console.log('Node:', {
                    labels: d.labels,
                    properties: d.properties,
                    visible: d3.select(this).style('opacity') === '1'
                });
            });
        }

        // Load and initialize the visualization
        fetch('/graph')
            .then(response => response.json())
            .then(data => {
                console.log('Graph data:', data);
                initializeVisualization(data);
                // Add click handler to log data for debugging
                document.addEventListener('keypress', function(e) {
                    if (e.key === 'd') logNodeData();
                });
            })
            .catch(error => console.error('Error loading graph:', error));
    </script>
</body>
</html>
