<!DOCTYPE html>
<html>
<head>
    <title>Neo4j Force Graph</title>
    <script src="https://unpkg.com/neo4j-driver@5.15.0"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        body { 
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
            font-family: Arial, sans-serif;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #searchBox {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #404040;
            background-color: #2d2d2d;
            color: white;
            width: 200px;
        }
        #searchResults {
            position: absolute;
            background-color: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            width: 200px;
            display: none;
        }
        .search-result {
            padding: 8px;
            cursor: pointer;
        }
        .search-result:hover {
            background-color: #404040;
        }
        #graph {
            width: 100%;
            height: 800px;
            background-color: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 4px;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .button {
            padding: 10px 20px;
            background-color: #cc5500;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .button:hover {
            background-color: #ff6a00;
        }
        .node-label {
            font-size: 8px;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
        }
        .link {
            stroke: #808080;
            stroke-opacity: 0.6;
        }
        .link-label {
            font-size: 8px;
            fill: #cccccc;
        }
        .highlighted {
            stroke: #ffff00;
            stroke-width: 3px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button class="button" onclick="showRandomNodesWithRelationships()">Show Random Connected Nodes</button>
        <input type="text" id="searchBox" placeholder="Search nodes..." onkeyup="searchNodes(this.value)">
        <div id="searchResults"></div>
    </div>
    <div id="status">Ready to connect...</div>
    <div id="graph"></div>

    <script>
        let driver;
        let currentNodes = [];
        let currentSimulation;
        
        async function initDriver() {
            try {
                driver = neo4j.driver(
                    "neo4j+s://4e5eeae5.databases.neo4j.io:7687",
                    neo4j.auth.basic("neo4j", "Poconoco16!")
                );
                
                const session = driver.session();
                await session.run("RETURN 1");
                await session.close();
                
                document.getElementById('status').style.backgroundColor = '#28a745';
                document.getElementById('status').innerHTML = 'Connected to database';
            } catch (error) {
                document.getElementById('status').style.backgroundColor = '#dc3545';
                document.getElementById('status').innerHTML = 'Connection error: ' + error.message;
                console.error('Connection error:', error);
            }
        }

        function searchNodes(searchText) {
            const searchResults = document.getElementById('searchResults');
            if (!searchText) {
                searchResults.style.display = 'none';
                return;
            }

            const matchingNodes = currentNodes.filter(node => 
                node.name.toLowerCase().includes(searchText.toLowerCase())
            );

            searchResults.innerHTML = '';
            matchingNodes.forEach(node => {
                const div = document.createElement('div');
                div.className = 'search-result';
                div.textContent = node.name;
                div.onclick = () => highlightNode(node);
                searchResults.appendChild(div);
            });

            searchResults.style.display = matchingNodes.length > 0 ? 'block' : 'none';
        }

        function highlightNode(node) {
            // Remove previous highlights
            d3.selectAll('circle').classed('highlighted', false);
            
            // Highlight the selected node
            d3.selectAll('circle')
                .filter(d => d.id === node.id)
                .classed('highlighted', true);

            // Hide search results
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchBox').value = node.name;
        }

        async function showRandomNodesWithRelationships() {
            if (!driver) {
                document.getElementById('status').style.backgroundColor = '#dc3545';
                document.getElementById('status').innerHTML = 'Not connected to database';
                return;
            }

            const session = driver.session();
            document.getElementById('status').innerHTML = 'Fetching data...';
            
            try {
                const result = await session.run(`
                    MATCH (n)
                    WITH n, rand() as random
                    ORDER BY random
                    LIMIT 5
                    MATCH (n)-[rel]-(m)
                    RETURN DISTINCT n, rel, m
                    LIMIT 15
                `);
                
                document.getElementById('status').innerHTML = 'Processing data...';
                
                const nodes = new Map();
                const links = [];
                
                result.records.forEach(record => {
                    const source = record.get('n');
                    const target = record.get('m');
                    const relationship = record.get('rel');
                    
                    if (!nodes.has(source.identity.toString())) {
                        nodes.set(source.identity.toString(), {
                            id: source.identity.toString(),
                            label: source.labels[0],
                            name: source.properties.name || 'Unnamed'
                        });
                    }
                    
                    if (!nodes.has(target.identity.toString())) {
                        nodes.set(target.identity.toString(), {
                            id: target.identity.toString(),
                            label: target.labels[0],
                            name: target.properties.name || 'Unnamed'
                        });
                    }
                    
                    links.push({
                        source: source.identity.toString(),
                        target: target.identity.toString(),
                        type: relationship.type
                    });
                });
                
                currentNodes = Array.from(nodes.values());
                document.getElementById('status').innerHTML = 'Rendering graph...';
                createForceGraph(currentNodes, links);
                document.getElementById('status').style.backgroundColor = '#28a745';
                document.getElementById('status').innerHTML = 'Graph rendered successfully';
                
            } catch (error) {
                document.getElementById('status').style.backgroundColor = '#dc3545';
                document.getElementById('status').innerHTML = 'Error: ' + error.message;
                console.error('Error:', error);
            } finally {
                await session.close();
            }
        }

        function createForceGraph(nodes, links) {
            d3.select("#graph").selectAll("*").remove();
            
            const width = document.getElementById('graph').clientWidth;
            const height = document.getElementById('graph').clientHeight;
            
            const svg = d3.select("#graph")
                .append("svg")
                .attr("width", width)
                .attr("height", height);
            
            currentSimulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(200))
                .force("charge", d3.forceManyBody().strength(-500))
                .force("center", d3.forceCenter(width / 2, height / 2));
            
            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .enter()
                .append("line")
                .attr("class", "link")
                .style("stroke", "#808080")
                .style("stroke-width", 2);
            
            const linkLabel = svg.append("g")
                .selectAll("text")
                .data(links)
                .enter()
                .append("text")
                .attr("class", "link-label")
                .text(d => d.type);
            
            const node = svg.append("g")
                .selectAll("g")
                .data(nodes)
                .enter()
                .append("g");
            
            node.append("circle")
                .attr("r", 30)
                .style("fill", "#cc5500")
                .style("stroke", "#ff6a00")
                .style("stroke-width", 2);
            
            node.append("text")
                .attr("class", "node-label")
                .attr("dy", ".35em")
                .text(d => d.name)
                .each(function(d) {
                    const text = d3.select(this);
                    const words = d.name.split(' ');
                    const lineHeight = 1.1;
                    const y = text.attr("y");
                    const dy = parseFloat(text.attr("dy"));
                    
                    text.text('');
                    
                    let tspan = text.append("tspan")
                        .attr("x", 0)
                        .attr("y", y)
                        .attr("dy", dy + "em");
                    
                    let line = [];
                    words.forEach(word => {
                        line.push(word);
                        tspan.text(line.join(" "));
                        
                        if (tspan.node().getComputedTextLength() > 45) {
                            line.pop();
                            tspan.text(line.join(" "));
                            line = [word];
                            tspan = text.append("tspan")
                                .attr("x", 0)
                                .attr("dy", lineHeight + "em")
                                .text(word);
                        }
                    });
                });
            
            node.call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
            
            currentSimulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                linkLabel
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2);
                
                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            });
            
            function dragstarted(d) {
                if (!d3.event.active) currentSimulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }
            
            function dragended(d) {
                if (!d3.event.active) currentSimulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        document.addEventListener('DOMContentLoaded', initDriver);

        window.onbeforeunload = () => {
            if (driver) {
                driver.close();
            }
        };
    </script>
</body>
</html>
