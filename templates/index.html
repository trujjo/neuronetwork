<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
    <style>
        :root {
            --burnt-orange: #CC5500;
            --dark-bg: #1a1a1a;
            --light-text: #ffffff;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--light-text);
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .sidebar {
            width: 250px;
        }

        .main-content {
            flex-grow: 1;
        }

        #network {
            height: 600px;
            border: 1px solid #444;
            background-color: #2d2d2d;
        }

        .search-box {
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 8px;
            background-color: #2d2d2d;
            border: 1px solid #444;
            color: white;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-button {
            background-color: #2d2d2d;
            color: white;
            border: 1px solid #444;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
        }

        .filter-button.active {
            background-color: var(--burnt-orange);
            border-color: var(--burnt-orange);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search nodes...">
            </div>
            
            <h3>Node Types</h3>
            <div id="nodeTypeButtons" class="filter-buttons"></div>
            
            <h3>Locations</h3>
            <div id="locationButtons" class="filter-buttons"></div>
        </div>
        
        <div class="main-content">
            <div id="network"></div>
        </div>
    </div>

    <script>
        // Initialize network
        const container = document.getElementById('network');
        const data = {
            nodes: new vis.DataSet([]),
            edges: new vis.DataSet([])
        };
        
        const options = {
            nodes: {
                shape: 'dot',
                size: 16,
                font: {
                    color: '#ffffff'
                }
            },
            edges: {
                color: {
                    color: '#ffffff',
                    highlight: '#CC5500'
                }
            },
            physics: {
                stabilization: false,
                barnesHut: {
                    gravitationalConstant: -80000,
                    springConstant: 0.001,
                    springLength: 200
                }
            }
        };
        
        const network = new vis.Network(container, data, options);

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;

        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const searchTerm = e.target.value.trim();
            
            if (searchTerm.length < 2) {
                resetHighlights();
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`/api/search?term=${encodeURIComponent(searchTerm)}`)
                    .then(response => response.json())
                    .then(matchedIds => {
                        highlightNodes(matchedIds);
                    });
            }, 300);
        });

        function highlightNodes(nodeIds) {
            data.nodes.forEach(node => {
                if (nodeIds.includes(node.id)) {
                    node.color = {
                        background: '#CC5500',
                        border: '#CC5500'
                    };
                } else {
                    delete node.color;
                }
                data.nodes.update(node);
            });

            if (nodeIds.length > 0) {
                network.focus(nodeIds[0], {
                    scale: 1.5,
                    animation: true
                });
            }
        }

        function resetHighlights() {
            data.nodes.forEach(node => {
                delete node.color;
                data.nodes.update(node);
            });
        }

        // Load and create filter buttons
        function createFilterButtons() {
            // Load node types
            fetch('/api/node_types')
                .then(response => response.json())
                .then(types => {
                    const container = document.getElementById('nodeTypeButtons');
                    types.forEach(type => {
                        const button = document.createElement('button');
                        button.className = 'filter-button';
                        button.textContent = type;
                        button.onclick = () => toggleNodeType(type, button);
                        container.appendChild(button);
                    });
                });

            // Load locations
            fetch('/api/locations')
                .then(response => response.json())
                .then(locations => {
                    const container = document.getElementById('locationButtons');
                    locations.forEach(location => {
                        const button = document.createElement('button');
                        button.className = 'filter-button';
                        button.textContent = location;
                        button.onclick = () => toggleLocation(location, button);
                        container.appendChild(button);
                    });
                });
        }

        function toggleNodeType(type, button) {
            button.classList.toggle('active');
            const activeTypes = Array.from(document.querySelectorAll('#nodeTypeButtons .active'))
                .map(btn => btn.textContent);
            
            data.nodes.forEach(node => {
                node.hidden = activeTypes.length > 0 && !node.labels.includes(type);
                data.nodes.update(node);
            });
        }

        function toggleLocation(location, button) {
            button.classList.toggle('active');
            const activeLocations = Array.from(document.querySelectorAll('#locationButtons .active'))
                .map(btn => btn.textContent);
            
            data.nodes.forEach(node => {
                node.hidden = activeLocations.length > 0 && node.location !== location;
                data.nodes.update(node);
            });
        }

        // Load initial graph data
        fetch('/api/graph')
            .then(response => response.json())
            .then(graphData => {
                data.nodes.add(graphData.nodes);
                data.edges.add(graphData.edges);
                createFilterButtons();
            });
    </script>
</body>
</html>
