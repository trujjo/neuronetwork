<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo4j Network Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #mynetwork {
            width: 100%;
            height: 80vh;
            border: 1px solid lightgray;
            background-color: #ffffff;
        }
        .filter-section {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .filter-button {
            margin: 5px;
            padding: 5px 10px;
            border: 1px solid #007bff;
            border-radius: 15px;
            background-color: white;
            color: #007bff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-button.active {
            background-color: #007bff;
            color: white;
        }
        .filter-button:hover {
            background-color: #0056b3;
            color: white;
        }
        .location-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .sublocation-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .type-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }
        .grayed-out {
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center my-4">Anatomical Network Visualization</h1>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="filter-section">
                    <h4>Node Types</h4>
                    <div class="type-filter" id="nodeTypeFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>Locations</h4>
                    <div class="location-filter" id="locationFilters"></div>
                </div>
                
                <div class="filter-section">
                    <h4>Sublocations</h4>
                    <div class="sublocation-filter" id="sublocationFilters"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div id="mynetwork"></div>
            </div>
        </div>
    </div>

    <script>
        const nodeTypes = [
            'nerve', 'bone', 'neuro', 'region', 'viscera', 'muscle', 
            'sense', 'vein', 'artery', 'cv', 'function', 'sensory',
            'gland', 'lymph', 'head', 'organ', 'sensation', 'skin'
        ];

        const locationPairs = {
            'head': ['brain', 'eye', 'face', 'ear', 'nose', 'skull', 'mouth', 'head'],
            'neck': ['cervical spine', 'visceral', 'vascular'],
            'upper limb': ['wrist', 'hand', 'fingers', 'arm', 'forearm', 'elbow', 'shoulder'],
            'thorax': ['thoracic spine', 'ribcage', 'heart', 'lung'],
            'abdomen': ['lumbar spine', 'right upper quadrant', 'left upper quadrant', 'right lower quadrant', 'left lower quadrant'],
            'spine': ['spinal cord', 'vertebral', 'tracts', 'sacral spine'],
            'pelvis': ['sacral spine', 'greater pelvis', 'lesser pelvis'],
            'lower limb': ['foot', 'thigh', 'knee', 'leg', 'ankle', 'toes']
        };

        let network = null;
        let allNodes = [];
        let allEdges = [];
        let currentFilters = {
            type: null,
            location: null,
            sublocation: null
        };

        // Create filter buttons
        function createFilterButtons() {
            const nodeTypeFilters = document.getElementById('nodeTypeFilters');
            nodeTypes.forEach(type => {
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.textContent = type;
                button.onclick = () => filterByType(type);
                nodeTypeFilters.appendChild(button);
            });

            const locationFilters = document.getElementById('locationFilters');
            Object.keys(locationPairs).forEach(location => {
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.textContent = location;
                button.onclick = () => filterByLocation(location);
                locationFilters.appendChild(button);
            });

            updateSublocationFilters();
        }

        function updateSublocationFilters(selectedLocation = null) {
            const sublocationFilters = document.getElementById('sublocationFilters');
            sublocationFilters.innerHTML = '';

            if (selectedLocation) {
                locationPairs[selectedLocation].forEach(sublocation => {
                    const button = document.createElement('button');
                    button.className = 'filter-button';
                    button.textContent = sublocation;
                    button.onclick = () => filterBySublocation(sublocation);
                    sublocationFilters.appendChild(button);
                });
            } else {
                Object.values(locationPairs).flat().forEach(sublocation => {
                    const button = document.createElement('button');
                    button.className = 'filter-button';
                    button.textContent = sublocation;
                    button.onclick = () => filterBySublocation(sublocation);
                    sublocationFilters.appendChild(button);
                });
            }
        }

        // Filter functions
        function filterByType(type) {
            currentFilters.type = currentFilters.type === type ? null : type;
            updateVisualization();
            updateButtonStates();
        }

        function filterByLocation(location) {
            currentFilters.location = currentFilters.location === location ? null : location;
            currentFilters.sublocation = null; // Reset sublocation when location changes
            updateVisualization();
            updateButtonStates();
            updateSublocationFilters(currentFilters.location);
        }

        function filterBySublocation(sublocation) {
            currentFilters.sublocation = currentFilters.sublocation === sublocation ? null : sublocation;
            updateVisualization();
            updateButtonStates();
        }

        function updateButtonStates() {
            document.querySelectorAll('.filter-button').forEach(button => {
                button.classList.remove('active');
                if (
                    (currentFilters.type && button.textContent === currentFilters.type) ||
                    (currentFilters.location && button.textContent === currentFilters.location) ||
                    (currentFilters.sublocation && button.textContent === currentFilters.sublocation)
                ) {
                    button.classList.add('active');
                }
            });
        }

        // Network visualization
        function initNetwork() {
            const container = document.getElementById('mynetwork');
            
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 16,
                    font: {
                        size: 12,
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 2,
                    color: {
                        color: '#848484',
                        highlight: '#1B5299',
                        hover: '#848484'
                    },
                    smooth: {
                        type: 'continuous'
                    }
                },
                physics: {
                    stabilization: false,
                    barnesHut: {
                        gravitationalConstant: -80000,
                        springConstant: 0.001,
                        springLength: 200
                    }
                },
                interaction: {
                    navigationButtons: true,
                    keyboard: true
                }
            };

            fetch('/api/graph')
                .then(response => response.json())
                .then(data => {
                    allNodes = new vis.DataSet(data.nodes);
                    allEdges = new vis.DataSet(data.edges);
                    
                    const networkData = {
                        nodes: allNodes,
                        edges: allEdges
                    };
                    
                    network = new vis.Network(container, networkData, options);
                });
        }

        function updateVisualization() {
            if (!network) return;

            fetch('/api/filter' + constructFilterQuery())
                .then(response => response.json())
                .then(data => {
                    network.setData({
                        nodes: new vis.DataSet(data.nodes),
                        edges: new vis.DataSet(data.edges)
                    });
                });
        }

        function constructFilterQuery() {
            const params = [];
            if (currentFilters.type) params.push(`type=${currentFilters.type}`);
            if (currentFilters.location) params.push(`location=${currentFilters.location}`);
            if (currentFilters.sublocation) params.push(`sublocation=${currentFilters.sublocation}`);
            return params.length ? '?' + params.join('&') : '';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            createFilterButtons();
            initNetwork();
        });
    </script>
</body>
</html>
"""

# Ensure templates directory exists
import os
if not os.path.exists('templates'):
    os.makedirs('templates')

# Write the HTML file
with open('templates/index.html', 'w') as f:
    f.write(html_content)
print("Created templates/index.html with visualization code")
