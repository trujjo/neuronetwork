<!DOCTYPE html>
<html>
<head>
    <title>Neo4j Network Visualization</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        #mynetwork {
            width: 80%;
            height: 600px;
            border: 1px solid lightgray;
        }
        .controls {
            margin: 20px;
        }
        .button-group {
            margin: 10px 0;
        }
        .filter-button {
            background-color: #CC5500;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 4px;
            border-radius: 4px;
            cursor: pointer;
        }
        .filter-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .search-container {
            margin: 20px 0;
            display: flex;
            gap: 20px;
        }
        .search-box {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }
        .search-button {
            background-color: #CC5500;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="controls">
        <!-- Add search boxes -->
        <div class="search-container">
            <div>
                <label for="source-search">Source Node:</label>
                <input type="text" id="source-search" class="search-box" placeholder="Search source node...">
            </div>
            <div>
                <label for="target-search">Target Node:</label>
                <input type="text" id="target-search" class="search-box" placeholder="Search target node...">
            </div>
            <button onclick="searchNodes()" class="search-button">Search</button>
            <button onclick="clearSearch()" class="search-button">Clear Search</button>
        </div>

        <!-- Existing button groups -->
        <div class="button-group">
            <h3>Node Types</h3>
            {% for node_type in metadata.node_types %}
            <button class="filter-button" onclick="addNodesByType('{{ node_type }}')" data-criteria="type" data-value="{{ node_type }}">
                {{ node_type }}
            </button>
            {% endfor %}
        </div>
        <!-- ... (other button groups remain the same) -->
    </div>
    <div id="mynetwork"></div>

    <script type="text/javascript">
        var nodes = new vis.DataSet([]);
        var edges = new vis.DataSet([]);
        
        var container = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        
        var options = {
            nodes: {
                shape: 'dot',
                size: 30,
                font: {
                    size: 14,
                    face: 'arial'
                },
                label: undefined,  // Will be set dynamically
                color: {
                    background: '#CC5500',
                    border: '#994000',
                    highlight: {
                        background: '#FF6A00',
                        border: '#994000'
                    }
                }
            },
            edges: {
                arrows: 'to',
                color: {
                    color: '#848484',
                    highlight: '#848484'
                },
                font: {
                    size: 12,
                    align: 'middle'
                }
            },
            physics: {
                enabled: false  // Disable physics for fixed positions
            }
        };
        
        var network = new vis.Network(container, data, options);

        function searchNodes() {
            const sourceSearch = document.getElementById('source-search').value.toLowerCase();
            const targetSearch = document.getElementById('target-search').value.toLowerCase();
            
            // Reset all nodes visibility
            nodes.update(nodes.get().map(node => ({
                ...node,
                hidden: false
            })));
            
            // Hide nodes that don't match search criteria
            if (sourceSearch || targetSearch) {
                const visibleNodeIds = new Set();
                
                edges.get().forEach(edge => {
                    const sourceNode = nodes.get(edge.from);
                    const targetNode = nodes.get(edge.to);
                    
                    const sourceMatch = !sourceSearch || sourceNode.label.toLowerCase().includes(sourceSearch);
                    const targetMatch = !targetSearch || targetNode.label.toLowerCase().includes(targetSearch);
                    
                    if (sourceMatch && targetMatch) {
                        visibleNodeIds.add(edge.from);
                        visibleNodeIds.add(edge.to);
                    }
                });
                
                nodes.update(nodes.get().map(node => ({
                    ...node,
                    hidden: !visibleNodeIds.has(node.id)
                })));
            }
            
            updateFilterButtons();
        }

        function clearSearch() {
            document.getElementById('source-search').value = '';
            document.getElementById('target-search').value = '';
            nodes.update(nodes.get().map(node => ({
                ...node,
                hidden: false
            })));
            updateFilterButtons();
        }

        // Update the addNodesByType function to include labels
        function addNodesByType(nodeType) {
            fetch('/get_nodes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    node_type: nodeType
                })
            })
            .then(response => response.json())
            .then(newNodes => {
                // Add labels to nodes
                newNodes = newNodes.map(node => ({
                    ...node,
                    label: node.properties.name || node.properties.id || node.id.toString(),
                    title: JSON.stringify(node.properties, null, 2)
                }));
                nodes.update(newNodes);
                updateFilterButtons();
            });
        }

        // ... (other existing functions remain the same)
    </script>
</body>
</html>
